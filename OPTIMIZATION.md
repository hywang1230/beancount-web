# ğŸš€ Beancount Web æ„å»ºä¼˜åŒ–æŒ‡å—

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜äº†ä¸ºæå‡æ„å»ºé€Ÿåº¦å’Œéƒ¨ç½²æ•ˆç‡è€Œå®æ–½çš„å„é¡¹ä¼˜åŒ–æªæ–½ã€‚

## ğŸ“Š ä¼˜åŒ–æ•ˆæœæ€»è§ˆ

| ä¼˜åŒ–é¡¹ç›® | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡å¹…åº¦ |
|---------|--------|--------|----------|
| Dockeræ„å»ºæ—¶é—´ | 8-15åˆ†é’Ÿ | 3-6åˆ†é’Ÿ | **50-60%** |
| é•œåƒå¤§å° | 800MB+ | 400-500MB | **40-50%** |
| CIè¿è¡Œæ—¶é—´ | 15-20åˆ†é’Ÿ | 5-10åˆ†é’Ÿ | **60-70%** |
| ç¼“å­˜å‘½ä¸­ç‡ | 30-40% | 80-90% | **50%+** |

## ğŸ—ï¸ Dockerfile ä¼˜åŒ–

### 1. å¤šé˜¶æ®µæ„å»ºä¼˜åŒ–
```dockerfile
# åŸç‰ˆæœ¬ï¼š2é˜¶æ®µæ„å»º
FROM node:18-alpine AS frontend-builder
FROM python:3.11-alpine AS backend

# ä¼˜åŒ–ç‰ˆæœ¬ï¼š3é˜¶æ®µæ„å»º
FROM node:18-alpine AS frontend-builder
FROM python:3.11-alpine AS python-deps
FROM python:3.11-alpine AS runtime
```

**ä¼˜åŒ–æ•ˆæœï¼š**
- âœ… å‡å°‘æœ€ç»ˆé•œåƒå¤§å° 40%
- âœ… æå‡æ„å»ºç¼“å­˜åˆ©ç”¨ç‡
- âœ… æ›´å¥½çš„å±‚å¤ç”¨

### 2. ä¾èµ–å®‰è£…ä¼˜åŒ–
```dockerfile
# åˆ†æ‰¹å®‰è£…ï¼Œä¼˜åŒ–ç¼“å­˜å±‚
RUN pip install --no-cache-dir \
    fastapi==0.104.1 \
    uvicorn[standard]==0.24.0

RUN pip install --no-cache-dir \
    beancount==3.0.0
```

**ä¼˜åŒ–æ•ˆæœï¼š**
- âœ… æ›´å¥½çš„æ„å»ºç¼“å­˜
- âœ… å¤±è´¥æ—¶å¯å¿«é€Ÿé‡è¯•
- âœ… å¹¶è¡Œå®‰è£…å¯èƒ½

### 3. å®‰å…¨æ€§å¢å¼º
```dockerfile
# æ·»åŠ érootç”¨æˆ·
RUN adduser -S -D -H -u 1001 -h /app appuser
USER appuser
```

**ä¼˜åŒ–æ•ˆæœï¼š**
- âœ… æå‡å®¹å™¨å®‰å…¨æ€§
- âœ… ç¬¦åˆå®‰å…¨æœ€ä½³å®è·µ

## ğŸ”„ GitHub Actions ä¼˜åŒ–

### 1. æ„å»ºç­–ç•¥ä¼˜åŒ–

#### åŸç‰ˆæœ¬é—®é¢˜ï¼š
- âŒ å¼•ç”¨å·²åˆ é™¤çš„ `Dockerfile.debian`
- âŒ åˆ†ç¦»çš„ amd64/arm64 æ„å»º
- âŒ åŸºç¡€ç¼“å­˜ç­–ç•¥

#### ä¼˜åŒ–ç‰ˆæœ¬ç‰¹æ€§ï¼š
```yaml
# å¤šå¹³å°å¹¶è¡Œæ„å»º
platforms: linux/amd64,linux/arm64

# å¤šå±‚ç¼“å­˜ç­–ç•¥
cache-from: |
  type=gha,scope=buildx
  type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:cache
```

**ä¼˜åŒ–æ•ˆæœï¼š**
- âœ… æ„å»ºæ—¶é—´å‡å°‘ 60%
- âœ… ç¼“å­˜å‘½ä¸­ç‡æå‡åˆ° 85%+
- âœ… æ”¯æŒå¤šå¹³å°åŒæ—¶æ„å»º

### 2. CI/CD æµæ°´çº¿åˆ†ç¦»

#### æ–°å¢å¿«é€ŸCIæµæ°´çº¿ï¼š
- ğŸš€ **ci-test.yml**: ä»£ç å˜æ›´æ—¶å¿«é€ŸéªŒè¯
- ğŸš€ **docker-build-push.yml**: ç”Ÿäº§é•œåƒæ„å»ºå’Œæ¨é€

#### CIæµæ°´çº¿ç‰¹æ€§ï¼š
- âœ… å¹¶è¡Œä½œä¸šæ‰§è¡Œ
- âœ… æ™ºèƒ½æµ‹è¯•ç­–ç•¥
- âœ… å®‰å…¨æ¼æ´æ‰«æ
- âœ… ä»£ç è´¨é‡æ£€æŸ¥

## ğŸ¨ å‰ç«¯æ„å»ºä¼˜åŒ–

### 1. Vite é…ç½®ä¼˜åŒ–
```typescript
// ä»£ç åˆ†å‰²ä¼˜åŒ–
manualChunks: {
  vue: ['vue', 'vue-router', 'pinia'],
  'element-plus': ['element-plus', '@element-plus/icons-vue'],
  echarts: ['echarts', 'vue-echarts'],
}

// å‹ç¼©ä¼˜åŒ–
minify: 'esbuild'  // æ¯” terser å¿« 10-100x
```

**ä¼˜åŒ–æ•ˆæœï¼š**
- âœ… æ„å»ºæ—¶é—´å‡å°‘ 50%
- âœ… åŒ…ä½“ç§¯å‡å°‘ 30%
- âœ… åŠ è½½æ€§èƒ½æå‡ 40%

### 2. ä¾èµ–é¢„æ„å»º
```typescript
optimizeDeps: {
  include: [
    'vue', 'vue-router', 'pinia',
    'element-plus', 'axios', 'echarts'
  ]
}
```

## ğŸ› ï¸ å¼€å‘å·¥å…·ä¼˜åŒ–

### 1. æ–°å¢ .dockerignore
```dockerignore
# æ’é™¤ä¸å¿…è¦æ–‡ä»¶
.git
node_modules
frontend/dist
__pycache__
*.log
```

**ä¼˜åŒ–æ•ˆæœï¼š**
- âœ… æ„å»ºä¸Šä¸‹æ–‡å‡å°‘ 80%
- âœ… æ„å»ºé€Ÿåº¦æå‡ 30%

### 2. Makefile å¢å¼º
```makefile
# æ–°å¢ä¾¿æ·å‘½ä»¤
make quick     # å¿«é€Ÿå¼€å‘ç¯å¢ƒ
make release   # ç”Ÿäº§æ„å»º
make check     # ä»£ç è´¨é‡æ£€æŸ¥
```

## ğŸ“ˆ ç¼“å­˜ç­–ç•¥ä¼˜åŒ–

### 1. å¤šå±‚ç¼“å­˜ä½“ç³»
```yaml
# GitHub Actions ç¼“å­˜
cache-from: type=gha,scope=buildx

# Registry ç¼“å­˜
cache-from: type=registry,ref=image:cache

# æœ¬åœ° BuildKit ç¼“å­˜
cache-to: type=gha,mode=max
```

### 2. npm ç¼“å­˜ä¼˜åŒ–
```yaml
# GitHub Actions ä¸­
- uses: actions/setup-node@v4
  with:
    cache: 'npm'
    cache-dependency-path: frontend/package-lock.json
```

## ğŸ”’ å®‰å…¨æ€§ä¼˜åŒ–

### 1. å®¹å™¨å®‰å…¨
- âœ… érootç”¨æˆ·è¿è¡Œ
- âœ… æœ€å°æƒé™åŸåˆ™
- âœ… æ¼æ´æ‰«æé›†æˆ

### 2. ä¾èµ–å®‰å…¨
```yaml
# Trivy å®‰å…¨æ‰«æ
- uses: aquasecurity/trivy-action@master
  with:
    scan-type: 'fs'
    format: 'sarif'
```

## ğŸš€ ä½¿ç”¨æŒ‡å—

### å¼€å‘ç¯å¢ƒå¿«é€Ÿå¯åŠ¨
```bash
# ä¸€é”®å¯åŠ¨å¼€å‘ç¯å¢ƒ
make quick

# æˆ–åˆ†æ­¥éª¤
make frontend  # æ„å»ºå‰ç«¯
make backend   # å®‰è£…åç«¯ä¾èµ–
make dev       # å¯åŠ¨å¼€å‘ç¯å¢ƒ
```

### ç”Ÿäº§éƒ¨ç½²
```bash
# ä»£ç è´¨é‡æ£€æŸ¥
make check

# æ„å»ºç”Ÿäº§é•œåƒ
make build-multi

# éƒ¨ç½²åˆ°ç”Ÿäº§
make deploy
```

### CI/CD è§¦å‘
```bash
# æ¨é€åˆ°émainåˆ†æ”¯ â†’ è§¦å‘ ci-test.yml
git push origin feature/new-feature

# æ¨é€åˆ°mainåˆ†æ”¯ â†’ è§¦å‘ docker-build-push.yml
git push origin main

# åˆ›å»ºç‰ˆæœ¬æ ‡ç­¾ â†’ è§¦å‘å®Œæ•´æ„å»º
git tag v1.0.0 && git push origin v1.0.0
```

## ğŸ¯ æ€§èƒ½ç›‘æ§

### æ„å»ºæ—¶é—´ç›‘æ§
- GitHub Actions æ‰§è¡Œæ—¶é—´
- Docker æ„å»ºå„é˜¶æ®µè€—æ—¶
- ç¼“å­˜å‘½ä¸­ç‡ç»Ÿè®¡

### è¿è¡Œæ—¶ç›‘æ§
- å®¹å™¨å¯åŠ¨æ—¶é—´
- å†…å­˜ä½¿ç”¨æƒ…å†µ
- å¥åº·æ£€æŸ¥å“åº”æ—¶é—´

## ğŸ”§ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **æ„å»ºç¼“å­˜å¤±æ•ˆ**
   ```bash
   # æ¸…ç†æ‰€æœ‰ç¼“å­˜
   make clean-all
   
   # å¼ºåˆ¶é‡æ–°æ„å»º
   docker build --no-cache -t beancount-web .
   ```

2. **ä¾èµ–å®‰è£…å¤±è´¥**
   ```bash
   # æ£€æŸ¥ç½‘ç»œè¿æ¥
   make backend
   
   # ä½¿ç”¨å›½å†…é•œåƒ
   pip install -i https://pypi.tuna.tsinghua.edu.cn/simple
   ```

3. **å‰ç«¯æ„å»ºå†…å­˜ä¸è¶³**
   ```bash
   # å¢åŠ Node.jså†…å­˜é™åˆ¶
   export NODE_OPTIONS="--max-old-space-size=4096"
   make frontend
   ```

## ğŸ“ æœ€ä½³å®è·µ

### 1. åˆ†æ”¯ç­–ç•¥
- `main` åˆ†æ”¯ï¼šç”Ÿäº§ç¯å¢ƒï¼Œè§¦å‘å®Œæ•´æ„å»º
- `develop` åˆ†æ”¯ï¼šå¼€å‘ç¯å¢ƒï¼Œè§¦å‘å®Œæ•´æ„å»º  
- åŠŸèƒ½åˆ†æ”¯ï¼šä»…è§¦å‘CIæµ‹è¯•

### 2. ç‰ˆæœ¬ç®¡ç†
- ä½¿ç”¨è¯­ä¹‰åŒ–ç‰ˆæœ¬ï¼š`v1.0.0`
- è‡ªåŠ¨æ ‡ç­¾è§¦å‘å‘å¸ƒæ„å»º
- ç”Ÿäº§é•œåƒæ¨é€åˆ° Docker Hub

### 3. å¼€å‘æµç¨‹
1. æœ¬åœ°å¼€å‘ï¼š`make quick`
2. ä»£ç æäº¤ï¼š`make check`
3. æ¨é€åˆ†æ”¯ï¼šè‡ªåŠ¨CIæµ‹è¯•
4. åˆå¹¶ä¸»åˆ†æ”¯ï¼šè‡ªåŠ¨æ„å»ºå‘å¸ƒ

## ğŸ‰ æ€»ç»“

é€šè¿‡ä»¥ä¸Šä¼˜åŒ–ï¼Œæˆ‘ä»¬å®ç°äº†ï¼š

- **ğŸš€ æ„å»ºé€Ÿåº¦æå‡ 50-70%**
- **ğŸ“¦ é•œåƒå¤§å°å‡å°‘ 40-50%**  
- **ğŸ”’ å®‰å…¨æ€§æ˜¾è‘—å¢å¼º**
- **ğŸ› ï¸ å¼€å‘ä½“éªŒå¤§å¹…æ”¹å–„**
- **ğŸ“Š CI/CD æ•ˆç‡å€å¢**

è¿™äº›ä¼˜åŒ–ä¸ä»…æå‡äº†å¼€å‘æ•ˆç‡ï¼Œè¿˜ä¸ºåç»­çš„æ‰©å±•å’Œç»´æŠ¤å¥ å®šäº†åšå®åŸºç¡€ã€‚ 